<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VENUSTARS Reviews</title>
    <style>
        :root { --main-color: #1a5c3a; --bg-color: #f9f7f4; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); margin: 0; padding: 0; }
        header { background: var(--main-color); color: white; text-align: center; padding: 2.5rem 1rem; }
        header h1 { margin: 0; font-size: 24px; letter-spacing: 1px; }
        header p { margin: 10px 0 0; opacity: 0.8; font-size: 14px; }
        
        .search-box { position: sticky; top: 0; background: var(--bg-color); padding: 15px; text-align: center; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        #searchInput { width: 90%; max-width: 500px; padding: 14px 25px; border: 2px solid var(--main-color); border-radius: 30px; font-size: 16px; outline: none; }
        #countText { font-size: 13px; color: var(--main-color); margin-top: 10px; font-weight: bold; min-height: 18px; }
        
        #reviewList { padding: 15px; max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card .date { font-size: 12px; color: #999; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .card .content { line-height: 1.7; color: #333; font-size: 15px; word-break: break-all; }
        .highlight { background: #fff176; color: #000; font-weight: bold; padding: 0 2px; border-radius: 2px; }
        
        /* 로딩 애니메이션 */
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(26,92,58,0.3); border-top-color: var(--main-color); border-radius: 50%; animation: spin 1s infinite linear; margin-right: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<header>
    <h1>VENUSTARS Reviews</h1>
    <p>실제 고객 17,145명의 리얼 사용 후기</p>
</header>

<div class="search-box">
    <input type="text" id="searchInput" placeholder="검색어를 입력하세요 (예: 항암, 당뇨)">
    <div id="countText"><div class="spinner"></div>데이터 금고 연결 중...</div>
</div>

<div id="reviewList"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBpqZEXkf6vq5cwpdeLADGTz8A0M3NKLjU",
        authDomain: "venustars.firebaseapp.com",
        projectId: "venustars",
        storageBucket: "venustars.firebasestorage.app",
        messagingSenderId: "171419456473",
        appId: "1:171419456473:web:d9b77b0608b5ef3201bfc8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let allReviews = [];

    async function loadData() {
        const countText = document.getElementById('countText');
        
        try {
            // [STEP 1] 처음 50개만 즉시 로딩 (사용자 대기시간 최소화)
            const firstQ = query(collection(db, "reviews"), limit(50));
            const snap = await getDocs(firstQ);
            allReviews = snap.docs.map(doc => {
                const data = doc.data();
                // 데이터 필드명 유연하게 매칭
                data._text = data['리뷰상세내용'] || data['reviews'] || data['내용'] || '';
                data._date = data['리뷰등록일'] || data['date'] || '';
                data._score = data['구매자 평점'] || data['rating'] || 5;
                return data;
            });
            render(allReviews); 
            countText.innerHTML = "⚡ 일부 로드 완료 (전체 데이터를 가져오는 중...)";

            // [STEP 2] 나머지 1.7만 개 백그라운드 로딩
            getDocs(collection(db, "reviews")).then(fullSnap => {
                allReviews = fullSnap.docs.map(doc => {
                    const data = doc.data();
                    data._text = data['리뷰상세내용'] || data['reviews'] || data['내용'] || '';
                    data._date = data['리뷰등록일'] || data['date'] || '';
                    data._score = data['구매자 평점'] || data['rating'] || 5;
                    return data;
                });
                countText.innerText = `✅ 총 ${allReviews.length.toLocaleString()}개 리뷰 연결 완료!`;
            });
        } catch (e) {
            countText.innerText = "❌ 연결 실패 (내일 오후에 다시 시도하거나 유료 전환이 필요합니다)";
            console.error(e);
        }
    }

    function render(data) {
        const list = document.getElementById('reviewList');
        const term = document.getElementById('searchInput').value.toLowerCase().trim();
        
        if (data.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">검색 결과가 없습니다.</div>';
            return;
        }

        list.innerHTML = data.map(r => {
            let content = r._text;
            if (term) {
                const regex = new RegExp(`(${term})`, 'gi');
                content = content.replace(regex, `<span class="highlight">$1</span>`);
            }
            return `
                <div class="card">
                    <div class="date">
